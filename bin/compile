#!/usr/bin/env bash
# usage: bin/compile <build-dir> <cache-dir> <env-dir>

set -eo pipefail

function arrow() {
  sed -u 's/^/----->  /'
}

function indent() {
  sed -u 's/^/       /'
}

function cat_or() {
  echo $(cat $1 2>/dev/null || echo $2)
}

BASE_DIR=$PWD
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

V_DIR=$CACHE_DIR/v

v_repo=$(cat_or $ENV_DIR/V_REPO "https://github.com/vlang/v.git")
v_branch=$(cat_or $ENV_DIR/V_BRANCH "master")

echo "Installing V..." | arrow

rm -Rf $V_DIR
git clone --depth 1 --branch $v_branch $v_repo $V_DIR
cd $V_DIR
make
cd $BUILD_DIR
$V_DIR/v run app.v

echo "using ${v_repo} @${v_branch}" | indent

