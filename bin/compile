#!/usr/bin/env bash
# usage: bin/compile <build-dir> <cache-dir> <env-dir>

set -eo pipefail
set -x

function arrow() {
  sed -u 's/^/----->  /'
}

function indent() {
  sed -u 's/^/       /'
}

function cat_or() {
  echo $(cat $1 2>/dev/null || echo $2)
}

BASE_DIR=$PWD
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

V_DIR=$CACHE_DIR/v

v_repo=$(cat_or $ENV_DIR/V_REPO "https://github.com/vlang/v.git")
v_branch=$(cat_or $ENV_DIR/V_BRANCH "master")

echo "Cloning V..." | arrow

rm -Rf $V_DIR
git clone --depth 1 --branch $v_branch $v_repo $V_DIR
cd $V_DIR
echo "Building V..." | arrow
make

PKGLIST=$BUILD_DIR/vpm.txt
if [ -f "$PKGLIST" ]; then
    echo "Found $PKGLIST, installing VPM packages" |Â arrow
    while read p; do
      $V_DIR/v install $p
    done <$PKGLIST
else 
    echo "$PKGLIST not found - do not install any VPM packages"
fi


cd $BUILD_DIR
$V_DIR/v app.v

echo "using ${v_repo} @${v_branch}" | indent

